% Codes for ECCV-16 work `Deep Cascaded Bi-Network for Face Hallucination'
% Any question please contact Shizhan Zhu: zhshzhutah2@gmail.com
% Released on August 19, 2016

function h4 = CBN_ghosting(h,GPU_ID)

if ~exist('GPU_ID','var'), GPU_ID = 7; end;
m = size(h,4);

% Just for the ease of the experiment for observing the ghosting effect,
% Manually set the high-frequency prior landmarks locations.
p = [17.1838, 17.3521, 17.9048, 18.8509, 20.4998, 22.9767, 25.9613, 29.2477, 32.9167, 36.504, 39.6457, ...
    42.4968, 44.7966, 46.2724, 46.9944, 47.3034, 47.3169, 19.7659, 21.6274, 24.2784, 27.0399, 29.555, ...
    34.2716, 36.8933, 39.6376, 42.3113, 44.199, 32.0843, 32.1472, 32.2174, 32.3022, 29.1902, 30.7384, ...
    32.347, 33.946, 35.3743, 22.8845, 24.5149, 26.481, 28.1882, 26.4454, 24.4773, 35.9244, 37.6581, ...
    39.6054, 41.2332, 39.7967, 37.8666, 26.6369, 28.8018, 30.9487, 32.3699, 33.9704, 36.1879, 38.3339, ...
    36.3315, 34.2412, 32.5255, 30.9552, 28.8135, 27.5327, 30.9664, 32.4101, 34.0305, 37.442, 34.0852, ...
    32.4404, 30.9623, 20.3928, 21.3377, 22.2788, 23.2584, 24.2742, 25.3014, 26.3222, 27.3355, 28.3551, ...
    28.936, 34.6391, 35.4747, 36.4768, 37.4731, 38.4793, 39.5001, 40.5276, 41.5374, 42.5143, 43.4687, ...
    29.3576, 28.874, 28.3485, 28.0437, 28.2815, 29.1034, 30.1466, 31.2199, 32.308, 33.3957, 34.4642, ...
    35.4939, 36.3148, 36.5525, 36.2322, 35.6601, 35.0912, 19.9263, 23.8997, 27.8621, 31.7037, 35.2409, ...
    38.3038, 40.8461, 42.8364, 43.3084, 42.5573, 40.3911, 37.735, 34.5732, 30.9211, 27.0045, 23.0374, ...
    19.0521, 16.8631, 15.0942, 14.5538, 14.9009, 15.9262, 15.6481, 14.4956, 14.0548, 14.5234, 16.1645, ...
    18.8854, 21.4504, 23.9948, 26.6164, 28.4499, 28.9779, 29.3958, 28.885, 28.3345, 19.4665, 18.4741, ...
    18.4807, 19.7138, 20.0881, 20.134, 19.4769, 18.1042, 18.0592, 18.9499, 19.6618, 19.7597, 33.3491, ...
    32.3795, 31.8897, 32.2386, 31.8211, 32.2361, 32.9846, 35.1419, 36.1247, 36.3518, 36.2332, 35.385, ...
    33.4265, 33.1776, 33.2929, 33.0811, 33.131, 34.191, 34.4346, 34.3011, 17.0602, 16.8629, 16.5503, ...
    16.3392, 16.2646, 16.3094, 16.4358, 16.6018, 16.675, 16.0817, 16.0679, 16.4899, 16.3564, 16.1325, ...
    15.934, 15.8061, 15.7816, 15.888, 16.1124, 16.2768, 24.0635, 24.9762, 25.9368, 26.975, 27.9939, ...
    28.6571, 28.9525, 29.1138, 29.1792, 29.0819, 28.884, 28.5593, 27.8964, 26.8814, 25.8527, 24.9204, 23.9372];
p = repmat(p, [m 1]);
mask1 = pt2mask(p / 2, 32, 1);
input1 = reshape(imresize(h, 2), [32 32 1 m]); 
h1 = batchForwardPDS('../',GPU_ID,{input1,mask1},'sr1','D432','jnt_24fnc','210000'); h1 = h1{1};

input2 = cat(3,reshape(imresize(h1, 2), [64 64 1 m]),reshape(imresize(input1, 2), [64 64 1 m]));
mask2 = pt2mask(p, 64, 3);
h2 = batchForwardPDS('../',GPU_ID,{input2,mask2},'sr1','D464_3B','jnt_12fnc', '230000'); h2 = h2{1};

mask3 = pt2mask(p * 2, 128, 5);
input3 = reshape(imresize(h2, 2), [128 128 1 m]);
h3 = batchForwardPDS('../',GPU_ID,{input3,mask3},'sr1','D4128_5C','msk_12fnc','1530000'); h3 = h3{1};
mask4 = pt2mask(p * 4, 256, 7);
input4 = reshape(imresize(h3, 2), [256 256 1 m]);
h4 = batchForwardPDS('../',GPU_ID,{input4,mask4},'sr1','D4256_7C','msk_12fnc','70000',1,16); h4 = h4{1};

end
