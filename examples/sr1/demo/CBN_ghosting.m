% Codes for ECCV-16 work `Deep Cascaded Bi-Network for Face Hallucination'
% Any question please contact Shizhan Zhu: zhshzhutah2@gmail.com
% Released on August 19, 2016

function h4 = CBN_ghosting(h,GPU_ID)

if ~exist('GPU_ID','var'), GPU_ID = 7; end;
m = size(h,4);

% Just for the ease of the experiment for observing the ghosting effect,
% Manually set the high-frequency prior landmarks locations.
p = [11.7099, 11.812, 12.4488, 13.5524, 15.6061, 18.8625, 22.8716, 27.3944, 32.591, 37.7481, 42.3443, 46.4694, 49.8047, 51.9137, 52.9999, 53.5848, 53.7569, 15.4211, 18.1077, 21.7398, 25.4283, 28.8021, 35.7989, 39.4334, 43.1652, 46.8272, 49.4612, 32.4113, 32.3929, 32.3807, 32.3787, 28.1896, 30.2286, 32.3746, 34.5657, 36.5215, 19.6982, 21.948, 24.6818, 26.9798, 24.5285, 21.8254, 37.8434, 40.2426, 42.9485, 45.141, 43.1603, 40.5138, 24.1604, 27.2379, 30.2926, 32.3403, 34.6496, 37.7598, 40.8131, 37.8955, 34.8776, 32.4057, 30.1365, 27.1037, 25.4566, 30.2745, 32.3615, 34.6973, 39.4974, 34.7303, 32.3606, 30.2246, 16.2201, 17.5625, 18.9026, 20.2924, 21.7211, 23.1504, 24.562, 25.9647, 27.3898, 28.2615, 35.9095, 37.0789, 38.5015, 39.9131, 41.3352, 42.7763, 44.2302, 45.6613, 47.043, 48.3918, 28.5817, 27.8596, 27.1131, 26.641, 26.9166, 28.0125, 29.4254, 30.891, 32.3927, 33.8932, 35.3687, 36.7902, 37.9183, 38.236, 37.7933, 37.0303, 36.2445, 19.9826, 25.5522, 31.1174, 36.5607, 41.6184, 46.042, 49.8705, 53.0223, 53.9377, 53.0025, 49.8577, 46.0565, 41.6205, 36.48, 30.965, 25.432, 19.8795, 15.4859, 13.199, 12.6895, 13.33, 14.8494, 14.6765, 13.1625, 12.587, 13.2098, 15.4515, 18.9545, 22.6331, 26.2839, 30.0236, 32.2715, 33.0945, 33.7957, 33.0886, 32.3359, 19.3822, 18.025, 18.1263, 19.9469, 20.4122, 20.3884, 19.9243, 18.0718, 18.0437, 19.3926, 20.3373, 20.394, 38.9289, 37.6628, 37.0739, 37.622, 37.0966, 37.7141, 38.8737, 42.1129, 43.5173, 43.7886, 43.551, 42.176, 39.1391, 38.9409, 39.1456, 38.9256, 39.1055, 40.6596, 40.9484, 40.7003, 15.8098, 15.5638, 15.1933, 15.0084, 15.0327, 15.2109, 15.4851, 15.8025, 15.9892, 15.2132, 15.371, 15.9711, 15.7772, 15.4554, 15.1629, 14.9577, 14.8859, 15.0118, 15.3371, 15.6087, 26.158, 27.3996, 28.7326, 30.1677, 31.5994, 32.562, 33.0918, 33.4283, 33.561, 33.4342, 33.1228, 32.6239, 31.6943, 30.2748, 28.8443, 27.5203, 26.146];
p = repmat(p, [m 1]);
mask1 = pt2mask(p / 2, 32, 1);
input1 = reshape(imresize(h, 2), [32 32 1 m]); 
h1 = batchForwardPDS('../',GPU_ID,{input1,mask1},'sr1','D432','jnt_24fnc','210000'); h1 = h1{1};

input2 = cat(3,reshape(imresize(h1, 2), [64 64 1 m]),reshape(imresize(input1, 2), [64 64 1 m]));
mask2 = pt2mask(p, 64, 3);
h2 = batchForwardPDS('../',GPU_ID,{input2,mask2},'sr1','D464_3B','jnt_12fnc', '230000'); h2 = h2{1};

mask3 = pt2mask(p * 2, 128, 5);
input3 = reshape(imresize(h2, 2), [128 128 1 m]);
h3 = batchForwardPDS('../',GPU_ID,{input3,mask3},'sr1','D4128_5C','msk_12fnc','1530000'); h3 = h3{1};
mask4 = pt2mask(p * 4, 256, 7);
input4 = reshape(imresize(h3, 2), [256 256 1 m]);
h4 = batchForwardPDS('../',GPU_ID,{input4,mask4},'sr1','D4256_7C','msk_12fnc','70000',1,16); h4 = h4{1};

end
